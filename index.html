<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŸºå»ºæ‹“è’ Â· åˆæˆçŸ³ä¸EXP</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
            user-select: none;
        }
        body {
            background: #0b0e14;
            margin: 0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 12px;
        }
        .game-container {
            max-width: 1400px;
            width: 100%;
            background: #1a1f2b;
            border-radius: 32px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.6);
            padding: 20px;
            border: 1px solid #2f3747;
        }
        /* é¡¶éƒ¨èµ„æºæ  */
        .resource-bar {
            background: #242b38;
            border-radius: 60px;
            padding: 12px 24px;
            margin-bottom: 24px;
            display: flex;
            flex-wrap: wrap;
            gap: 24px 36px;
            align-items: center;
            border: 1px solid #3e485a;
            box-shadow: inset 0 2px 5px #0f1219;
        }
        .resource-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            font-size: 1.2rem;
        }
        .resource-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #2f3b4b;
            border: 1px solid #5e6f88;
        }
        .exp { color: #b2e63e; text-shadow: 0 0 8px #5f9e2b; }
        .synth-stone { color: #ffd966; text-shadow: 0 0 8px #b8860b; }
        .player-level { background: #2d3748; padding: 4px 20px; border-radius: 40px; border: 1px solid #5f6b7f; }
        .power-badge { background: #1e2a36; padding: 4px 18px; border-radius: 40px; border: 1px solid #3f8ab3; color: #7ad0ff; }
        /* åˆ†é¡µæ ‡ç­¾ */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        .tab {
            background: #262e3c;
            color: #a3b3d1;
            padding: 12px 32px;
            border-radius: 40px 40px 0 0;
            font-weight: 600;
            cursor: pointer;
            border: 1px solid #384153;
            border-bottom: none;
            transition: 0.2s;
        }
        .tab.active {
            background: #2f3b4f;
            color: white;
            border-color: #6e7f9e;
            transform: translateY(-3px);
        }
        .page {
            background: #1e2532;
            border-radius: 0 24px 24px 24px;
            padding: 24px;
            border: 1px solid #30384a;
            min-height: 500px;
        }
        /* ä»“åº“ç½‘æ ¼ */
        .storage-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 12px;
        }
        .item-card {
            background: #272f3d;
            border-radius: 16px;
            padding: 12px 10px;
            border-left: 6px solid;
            display: flex;
            flex-direction: column;
            box-shadow: 0 5px 0 #0f131c;
            transition: 0.1s;
            border-image: none;
        }
        .item-white { border-color: #b0b0b0; }
        .item-green { border-color: #5fbb6b; }
        .item-blue { border-color: #5299e0; }
        .item-purple { border-color: #c168e0; }
        .item-gold { border-color: #efbf3f; }
        .item-name {
            font-weight: bold;
            font-size: 1rem;
            margin-bottom: 6px;
            color: #e1e9f5;
        }
        .item-qty {
            font-size: 1.5rem;
            font-weight: 800;
            color: white;
            margin-bottom: 8px;
        }
        .item-use {
            background: #3d4a5e;
            border: none;
            color: white;
            border-radius: 20px;
            padding: 5px 0;
            font-size: 0.8rem;
            cursor: pointer;
            transition: 0.2s;
        }
        .item-use:hover { background: #5f7291; }
        .item-use:active { transform: translateY(2px); }

        /* ç”Ÿäº§åŒºå»ºç­‘ç½‘æ ¼ */
        .buildings-grid {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }
        .building-category {
            background: #1b212c;
            border-radius: 24px;
            padding: 16px;
        }
        .building-card {
            background: #283040;
            border-radius: 24px;
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid #404b60;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: center;
        }
        .building-info {
            min-width: 200px;
        }
        .building-name {
            font-size: 1.3rem;
            font-weight: 700;
            color: #d6e3ff;
        }
        .building-level {
            background: #1e2735;
            display: inline-block;
            padding: 4px 16px;
            border-radius: 30px;
            font-size: 0.9rem;
            margin: 8px 0;
            color: #b9cbff;
        }
        .building-switch {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .switch {
            width: 52px;
            height: 28px;
            background: #3a4557;
            border-radius: 40px;
            position: relative;
            cursor: pointer;
            transition: 0.2s;
            border: 1px solid #5f6f88;
        }
        .switch.on { background: #4f9e6b; }
        .switch::after {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            top: 1px;
            left: 2px;
            transition: 0.2s;
        }
        .switch.on::after { left: 26px; }
        .recipe-select {
            background: #1f293b;
            color: white;
            border: 1px solid #5e6d8c;
            border-radius: 30px;
            padding: 8px 20px;
            min-width: 200px;
        }
        .progress-bar {
            width: 200px;
            height: 14px;
            background: #191f2b;
            border-radius: 20px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #78b5f5, #3f7ec6);
            width: 0%;
        }
        .power-cost {
            color: #9fb0d3;
            background: #1d2633;
            padding: 4px 10px;
            border-radius: 30px;
        }
        .btn {
            background: #364153;
            border: none;
            color: white;
            padding: 8px 20px;
            border-radius: 36px;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 3px solid #1a212d;
            transition: 0.1s;
        }
        .btn:active { transform: translateY(3px); border-bottom-width: 1px; }
        .btn-primary { background: #3f6792; border-bottom-color: #1f3853; }
        .build-panel {
            margin-top: 20px;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        .footer-notes {
            color: #6a7b9b;
            margin-top: 20px;
            font-size: 0.85rem;
            text-align: center;
        }
    </style>
</head>
<body>
<div class="game-container" id="gameApp">
    <!-- èµ„æºæ  -->
    <div class="resource-bar" id="resourceBar">
        <div class="resource-item"><span class="resource-icon">âš¡</span> <span id="powerDisplay">0/0</span></div>
        <div class="resource-item exp"><span class="resource-icon">ğŸ“Š</span> <span id="expDisplay">0</span></div>
        <div class="resource-item synth-stone"><span class="resource-icon">ğŸ’</span> <span id="synthStoneDisplay">0</span></div>
        <div class="player-level">ğŸ† Lv.<span id="playerLevel">1</span></div>
        <div class="power-badge">ğŸ”‹ ç”µé‡ <span id="powerUsage">0</span>/<span id="powerSupply">0</span></div>
    </div>

    <!-- åˆ†é¡µ -->
    <div class="tabs">
        <div class="tab active" id="tabProduction">ğŸ­ ç”Ÿäº§åŒº</div>
        <div class="tab" id="tabStorage">ğŸ“¦ ä»“åº“</div>
    </div>

    <!-- ç”Ÿäº§åŒºé¡µé¢ (é»˜è®¤æ˜¾ç¤º) -->
    <div class="page" id="productionPage">
        <div style="display: flex; justify-content: space-between; margin-bottom: 16px;">
            <h2 style="color:white; margin:0;">âš™ï¸ å»ºç­‘ç¾¤</h2>
            <button class="btn btn-primary" id="openBuildMenu">â• æ–°å»ºå»ºç­‘</button>
        </div>
        <div id="buildingsContainer" class="buildings-grid">
            <!-- åŠ¨æ€æ¸²æŸ“å»ºç­‘ -->
        </div>
        <!-- å¿«é€Ÿå»ºé€ é¢æ¿ (éšè—, ç‚¹å‡»æ–°å»ºå»ºç­‘æ˜¾ç¤º) -->
        <div id="buildSelector" style="display: none; background: #1b212c; border-radius: 30px; padding: 20px; margin-top: 16px;">
            <h3 style="color:white; margin-top:0;">é€‰æ‹©å»ºç­‘ç±»å‹</h3>
            <select id="buildingTypeSelect" style="width:300px; padding:10px; background:#2f3b4f; color:white; border-radius:30px; border:1px solid #61759b;">
                <option value="åˆ¶é€ ç«™">åˆ¶é€ ç«™</option><option value="åŠ å·¥ç«™">åŠ å·¥ç«™</option><option value="è´¸æ˜“ç«™">è´¸æ˜“ç«™</option>
                <option value="ç ”ç©¶æ‰€">ç ”ç©¶æ‰€</option><option value="é‡‡çŸ¿æœº">é‡‡çŸ¿æœº</option><option value="åŒ–å­¦é‡‡çŸ¿æœº">åŒ–å­¦é‡‡çŸ¿æœº</option>
                <option value="åˆæˆçŸ³é‡‡çŸ¿æœº">åˆæˆçŸ³é‡‡çŸ¿æœº</option><option value="åˆæˆçŸ³è½¬è´¨æœº">åˆæˆçŸ³è½¬è´¨æœº</option>
                <option value="ç§æ¤ç«™">ç§æ¤ç«™</option><option value="åˆæˆç«™">åˆæˆç«™</option><option value="å‘ç”µç«™">å‘ç”µç«™</option>
            </select>
            <button class="btn btn-primary" id="confirmBuild" style="margin-left:16px;">æ¶ˆè€—èµ„æºå»ºé€ </button>
            <button class="btn" id="cancelBuild">å–æ¶ˆ</button>
        </div>
    </div>

    <!-- ä»“åº“é¡µé¢ (åˆå§‹éšè—) -->
    <div class="page" id="storagePage" style="display: none;">
        <h2 style="color:white; margin-top:0;">ğŸ“¦ ç‰©èµ„ä»“åº“</h2>
        <div id="storageGrid" class="storage-grid">
            <!-- åŠ¨æ€ç‰©å“ -->
        </div>
    </div>
    <div class="footer-notes">âš¡ æ— çº¿è‡ªåŠ¨åŒ– Â· æ•°æ®è‡ªåŠ¨ä¿å­˜ Â· å»ºç­‘è€—ç”µ: æ™®é€š150/çŸ¿æœº200/ç‰¹æ®Š300</div>
</div>

<script>
(function() {
    // ---------- æ¸¸æˆé…ç½® ----------
    const STORAGE_KEY = 'baseGameSave';

    // æ‰€æœ‰ç‰©å“åˆ—è¡¨ (æŒ‰é¢œè‰²åˆ†ç±»)
    const ITEMS = {
        // ç™½è‰²
        'å¼‚é“ç¢ç‰‡': 'white', 'æºå²©': 'white', 'ç ´æŸè£…ç½®': 'white', 'é…¯åŸæ–™': 'white', 'åŒé…®': 'white', 'ä»£ç³–': 'white',
        // ç»¿è‰²
        'å¼‚é“': 'green', 'å›ºæºå²©': 'green', 'è£…ç½®': 'green', 'èšé…¸é…¯': 'green', 'é…®å‡é›†': 'green', 'ç³–': 'green', 'ç›': 'green', 'æµ†æœ': 'green', 'æµ†æœç§å­': 'green', 'ä½çº§expèµ„æ–™': 'green',
        // è“è‰²
        'å¼‚é“ç»„': 'blue', 'å›ºæºå²©ç»„': 'blue', 'å…¨æ–°è£…ç½®': 'blue', 'èšé…¸é…¯ç»„': 'blue', 'é…®å‡é›†ç»„': 'blue', 'ç³–ç»„': 'blue', 'è½¬è´¨ç›ç»„': 'blue', 'å‡èƒ¶': 'blue', 'èŠ½é’ˆ': 'blue', 'èŠ½é’ˆç§å­': 'blue', 'ä¸­çº§expèµ„æ–™': 'blue',
        // ç´«è‰²
        'å¼‚é“å—': 'purple', 'æçº¯æºå²©': 'purple', 'æ”¹é‡è£…ç½®': 'purple', 'èšé…¸é…¯å—': 'purple', 'é…®é˜µåˆ—': 'purple', 'ç³–èšå—': 'purple', 'è½¬è´¨ç›èšå—': 'purple', 'èšåˆå‡èƒ¶': 'purple', 'åˆæˆçŸ³åŸçŸ¿': 'purple', 'é«˜çº§expèµ„æ–™': 'purple',
        // é‡‘è‰²
        'åˆæˆçŸ³': 'gold'
    };

    // é…æ–¹åº“ (å»ºç­‘ç±»å‹, æœ€ä½ç­‰çº§, åç§°, è¾“å…¥, è¾“å‡º, è€—æ—¶ç§’)
    const RECIPES = [
        // åˆ¶é€ ç«™
        { bid: 'åˆ¶é€ ç«™', level: 1, name: 'ä½çº§EXP', input: { 'æºå²©':2, 'åŒé…®':1 }, output: { 'ä½çº§expèµ„æ–™':1 }, time: 10 },
        { bid: 'åˆ¶é€ ç«™', level: 1, name: 'æºå²©â†’å›ºæºå²©', input: { 'æºå²©':5 }, output: { 'å›ºæºå²©':1 }, time: 8 },
        { bid: 'åˆ¶é€ ç«™', level: 2, name: 'ä¸­çº§EXP', input: { 'å›ºæºå²©':2, 'é…®å‡é›†':1 }, output: { 'ä¸­çº§expèµ„æ–™':1 }, time: 30 },
        { bid: 'åˆ¶é€ ç«™', level: 2, name: 'å›ºæºå²©â†’å›ºæºå²©ç»„', input: { 'å›ºæºå²©':3 }, output: { 'å›ºæºå²©ç»„':1 }, time: 15 },
        { bid: 'åˆ¶é€ ç«™', level: 3, name: 'é«˜çº§EXP', input: { 'å›ºæºå²©ç»„':2, 'é…®å‡é›†ç»„':1 }, output: { 'é«˜çº§expèµ„æ–™':1 }, time: 90 },
        { bid: 'åˆ¶é€ ç«™', level: 3, name: 'å›ºæºå²©ç»„â†’æçº¯æºå²©', input: { 'å›ºæºå²©ç»„':3 }, output: { 'æçº¯æºå²©':1 }, time: 30 },
        // åŠ å·¥ç«™
        { bid: 'åŠ å·¥ç«™', level: 1, name: 'å¼‚é“ç¢ç‰‡â†’ç ´æŸè£…ç½®', input: { 'å¼‚é“ç¢ç‰‡':3 }, output: { 'ç ´æŸè£…ç½®':1 }, time: 6 },
        { bid: 'åŠ å·¥ç«™', level: 1, name: 'åŒé…®â†’é…®å‡é›†', input: { 'åŒé…®':2 }, output: { 'é…®å‡é›†':1 }, time: 5 },
        { bid: 'åŠ å·¥ç«™', level: 2, name: 'å¼‚é“â†’è£…ç½®', input: { 'å¼‚é“':3 }, output: { 'è£…ç½®':1 }, time: 10 },
        { bid: 'åŠ å·¥ç«™', level: 2, name: 'é…®å‡é›†â†’é…®å‡é›†ç»„', input: { 'é…®å‡é›†':3 }, output: { 'é…®å‡é›†ç»„':1 }, time: 12 },
        { bid: 'åŠ å·¥ç«™', level: 3, name: 'å¼‚é“ç»„â†’å…¨æ–°è£…ç½®', input: { 'å¼‚é“ç»„':3 }, output: { 'å…¨æ–°è£…ç½®':1 }, time: 20 },
        { bid: 'åŠ å·¥ç«™', level: 3, name: 'é…®å‡é›†ç»„â†’é…®é˜µåˆ—', input: { 'é…®å‡é›†ç»„':3 }, output: { 'é…®é˜µåˆ—':1 }, time: 25 },
        { bid: 'åŠ å·¥ç«™', level: 4, name: 'å¼‚é“å—â†’æ”¹é‡è£…ç½®', input: { 'å¼‚é“å—':2 }, output: { 'æ”¹é‡è£…ç½®':1 }, time: 40 },
        // è´¸æ˜“ç«™
        { bid: 'è´¸æ˜“ç«™', level: 1, name: 'è´¸æ˜“å¼‚é“', input: { 'åŒé…®':3, 'å¼‚é“ç¢ç‰‡':3 }, output: { 'å¼‚é“':1 }, time: 12 },
        { bid: 'è´¸æ˜“ç«™', level: 2, name: 'è´¸æ˜“å¼‚é“ç»„', input: { 'é…®å‡é›†':3, 'å¼‚é“':3 }, output: { 'å¼‚é“ç»„':1 }, time: 20 },
        { bid: 'è´¸æ˜“ç«™', level: 3, name: 'è´¸æ˜“å¼‚é“å—', input: { 'é…®å‡é›†ç»„':3, 'å¼‚é“ç»„':3 }, output: { 'å¼‚é“å—':1 }, time: 30 },
        { bid: 'è´¸æ˜“ç«™', level: 4, name: 'è´¸æ˜“åˆæˆçŸ³', input: { 'é…®é˜µåˆ—':3, 'åˆæˆçŸ³åŸçŸ¿':10 }, output: { 'åˆæˆçŸ³':10 }, time: 60 },
        // ç ”ç©¶æ‰€
        { bid: 'ç ”ç©¶æ‰€', level: 1, name: 'ç³–+èšé…¸é…¯', input: { 'ä»£ç³–':3, 'é…¯åŸæ–™':3 }, output: { 'ç³–':1, 'èšé…¸é…¯':1 }, time: 10 },
        { bid: 'ç ”ç©¶æ‰€', level: 2, name: 'ç³–ç»„+èšé…¸é…¯ç»„', input: { 'ç³–':3, 'èšé…¸é…¯':3 }, output: { 'ç³–ç»„':1, 'èšé…¸é…¯ç»„':1 }, time: 18 },
        { bid: 'ç ”ç©¶æ‰€', level: 2, name: 'ç›â†’è½¬è´¨ç›ç»„', input: { 'ç›':3 }, output: { 'è½¬è´¨ç›ç»„':1 }, time: 12 },
        { bid: 'ç ”ç©¶æ‰€', level: 3, name: 'ç³–èšå—+èšé…¸é…¯å—', input: { 'ç³–ç»„':3, 'èšé…¸é…¯ç»„':3 }, output: { 'ç³–èšå—':1, 'èšé…¸é…¯å—':1 }, time: 30 },
        { bid: 'ç ”ç©¶æ‰€', level: 3, name: 'è½¬è´¨ç›ç»„â†’è½¬è´¨ç›èšå—', input: { 'è½¬è´¨ç›ç»„':3 }, output: { 'è½¬è´¨ç›èšå—':1 }, time: 25 },
        // é‡‡çŸ¿æœº (æ— æ¶ˆè€—ï¼Œäº§å‡ºå¤šç§)
        { bid: 'é‡‡çŸ¿æœº', level: 1, name: 'åŸºç¡€å¼€é‡‡', input: { }, output: { 'æºå²©':3, 'å¼‚é“ç¢ç‰‡':1, 'ä»£ç³–':2 }, time: 12 },
        { bid: 'é‡‡çŸ¿æœº', level: 2, name: 'ä¸­çº§å¼€é‡‡', input: { }, output: { 'å›ºæºå²©':3, 'å¼‚é“':1, 'ç³–':2 }, time: 15 },
        { bid: 'é‡‡çŸ¿æœº', level: 3, name: 'é«˜çº§å¼€é‡‡', input: { }, output: { 'å›ºæºå²©ç»„':3, 'å¼‚é“ç»„':1, 'ç³–ç»„':2 }, time: 20 },
        // åŒ–å­¦é‡‡çŸ¿æœº
        { bid: 'åŒ–å­¦é‡‡çŸ¿æœº', level: 1, name: 'åŸºç¡€åŒ–å­¦', input: { }, output: { 'åŒé…®':2, 'é…¯åŸæ–™':1 }, time: 10 },
        { bid: 'åŒ–å­¦é‡‡çŸ¿æœº', level: 2, name: 'ä¸­çº§åŒ–å­¦', input: { }, output: { 'é…®å‡é›†':2, 'èšé…¸é…¯':1, 'ç›':1 }, time: 14 },
        { bid: 'åŒ–å­¦é‡‡çŸ¿æœº', level: 3, name: 'é«˜çº§åŒ–å­¦', input: { }, output: { 'é…®å‡é›†ç»„':2, 'èšé…¸é…¯ç»„':1, 'è½¬è´¨ç›ç»„':1 }, time: 18 },
        // åˆæˆçŸ³é‡‡çŸ¿æœº (æ¶ˆè€—)
        { bid: 'åˆæˆçŸ³é‡‡çŸ¿æœº', level: 1, name: 'åˆæˆçŸ³å¼€é‡‡I', input: { 'å¼‚é“':5 }, output: { 'åˆæˆçŸ³':1 }, time: 20 },
        { bid: 'åˆæˆçŸ³é‡‡çŸ¿æœº', level: 2, name: 'åˆæˆçŸ³å¼€é‡‡II', input: { 'å¼‚é“ç»„':3 }, output: { 'åˆæˆçŸ³':1 }, time: 18 },
        { bid: 'åˆæˆçŸ³é‡‡çŸ¿æœº', level: 3, name: 'åˆæˆçŸ³å¼€é‡‡III', input: { 'å¼‚é“å—':2 }, output: { 'åˆæˆçŸ³':1 }, time: 16 },
        // åˆæˆçŸ³è½¬è´¨æœº
        { bid: 'åˆæˆçŸ³è½¬è´¨æœº', level: 1, name: 'åŸçŸ¿è½¬åŒ–I', input: { 'è½¬è´¨ç›ç»„':5 }, output: { 'åˆæˆçŸ³åŸçŸ¿':1 }, time: 25 },
        { bid: 'åˆæˆçŸ³è½¬è´¨æœº', level: 2, name: 'åŸçŸ¿è½¬åŒ–II', input: { 'è½¬è´¨ç›èšå—':2 }, output: { 'åˆæˆçŸ³åŸçŸ¿':1 }, time: 22 },
        // ç§æ¤ç«™
        { bid: 'ç§æ¤ç«™', level: 1, name: 'ç§æµ†æœ', input: { 'æµ†æœç§å­':1 }, output: { 'æµ†æœ':1 }, time: 15 },
        { bid: 'ç§æ¤ç«™', level: 1, name: 'æµ†æœé‡‡ç§', input: { 'æµ†æœ':1 }, output: { 'æµ†æœç§å­':2 }, time: 8 },
        { bid: 'ç§æ¤ç«™', level: 2, name: 'ç§èŠ½é’ˆ', input: { 'èŠ½é’ˆç§å­':1 }, output: { 'èŠ½é’ˆ':1 }, time: 18 },
        { bid: 'ç§æ¤ç«™', level: 2, name: 'èŠ½é’ˆé‡‡ç§', input: { 'èŠ½é’ˆ':1 }, output: { 'èŠ½é’ˆç§å­':2 }, time: 10 },
        // åˆæˆç«™
        { bid: 'åˆæˆç«™', level: 1, name: 'å‡èƒ¶åˆæˆ', input: { 'æµ†æœ':1 }, output: { 'å‡èƒ¶':1 }, time: 8 },
        { bid: 'åˆæˆç«™', level: 2, name: 'èŠ½é’ˆâ†’å‡èƒ¶', input: { 'èŠ½é’ˆ':1 }, output: { 'å‡èƒ¶':2 }, time: 10 },
        { bid: 'åˆæˆç«™', level: 2, name: 'èšåˆå‡èƒ¶', input: { 'å‡èƒ¶':3 }, output: { 'èšåˆå‡èƒ¶':1 }, time: 18 },
    ];

    // å»ºç­‘ç±»å‹å¯¹åº”åŸºç¡€è€—ç”µ
    const POWER_COST = { 'åˆ¶é€ ç«™':150, 'åŠ å·¥ç«™':150, 'è´¸æ˜“ç«™':150, 'ç ”ç©¶æ‰€':150, 'é‡‡çŸ¿æœº':200, 'åŒ–å­¦é‡‡çŸ¿æœº':200, 'åˆæˆçŸ³é‡‡çŸ¿æœº':300, 'åˆæˆçŸ³è½¬è´¨æœº':300, 'ç§æ¤ç«™':150, 'åˆæˆç«™':150, 'å‘ç”µç«™':0 };

    // å‡çº§æ‰€éœ€ææ–™ä¸ç­‰çº§æ¡ä»¶
    const UPGRADE_REQ = {
        'åˆ¶é€ ç«™': { 2: { level:10, mat:{'è£…ç½®':5} }, 3: { level:20, mat:{'å…¨æ–°è£…ç½®':5} } },
        'åŠ å·¥ç«™': { 2: { level:10, mat:{'å›ºæºå²©':5} }, 3: { level:20, mat:{'å›ºæºå²©ç»„':5} }, 4: { level:40, mat:{'æçº¯æºå²©':5} } },
        'è´¸æ˜“ç«™': { 2: { level:10, mat:{'èšé…¸é…¯':5} }, 3: { level:20, mat:{'èšé…¸é…¯ç»„':5} }, 4: { level:40, mat:{'èšé…¸é…¯å—':5} } },
        'ç ”ç©¶æ‰€': { 2: { level:10, mat:{'é…®å‡é›†':5} }, 3: { level:20, mat:{'é…®å‡é›†ç»„':5} } },
        'é‡‡çŸ¿æœº': { 2: { level:15, mat:{'å›ºæºå²©':5} }, 3: { level:25, mat:{'å›ºæºå²©ç»„':5} } },
        'åŒ–å­¦é‡‡çŸ¿æœº': { 2: { level:15, mat:{'å¼‚é“':5} }, 3: { level:25, mat:{'å¼‚é“ç»„':5} } },
        'åˆæˆçŸ³é‡‡çŸ¿æœº': { 2: { level:10, mat:{'ç³–ç»„':5} }, 3: { level:20, mat:{'ç³–èšå—':5} } },
        'åˆæˆçŸ³è½¬è´¨æœº': { 2: { level:50, mat:{'èšåˆå‡èƒ¶':5} } },
        'ç§æ¤ç«™': { 2: { level:10, mat:{'ç³–ç»„':5} } },
        'åˆæˆç«™': { 2: { level:15, mat:{'é…®å‡é›†ç»„':5} } },
        'å‘ç”µç«™': { 2: { level:10, mat:{'å…¨æ–°è£…ç½®':5} }, 3: { level:20, mat:{'æ”¹é‡è£…ç½®':5} } },
    };

    // å»ºé€ æ‰€éœ€ (ä¸€çº§)
    const BUILD_REQ = {
        'åˆ¶é€ ç«™': { level:1, mat:{'ç ´æŸè£…ç½®':5} },
        'åŠ å·¥ç«™': { level:1, mat:{'æºå²©':5} },
        'è´¸æ˜“ç«™': { level:1, mat:{'é…¯åŸæ–™':5} },
        'ç ”ç©¶æ‰€': { level:1, mat:{'åŒé…®':5} },
        'é‡‡çŸ¿æœº': { level:1, mat:{'æºå²©':5} },
        'åŒ–å­¦é‡‡çŸ¿æœº': { level:1, mat:{'å¼‚é“ç¢ç‰‡':5} },
        'åˆæˆçŸ³é‡‡çŸ¿æœº': { level:1, mat:{'ç³–':5} },
        'åˆæˆçŸ³è½¬è´¨æœº': { level:35, mat:{'å‡èƒ¶':5} },
        'ç§æ¤ç«™': { level:1, mat:{'ç³–':5} },
        'åˆæˆç«™': { level:1, mat:{'é…®å‡é›†':5} },
        'å‘ç”µç«™': { level:1, mat:{'è£…ç½®':5} },
    };

    // åˆå§‹èµ„æº
    const INIT_RESOURCES = {
        'æºå²©':10, 'å¼‚é“ç¢ç‰‡':10, 'åŒé…®':10, 'é…¯åŸæ–™':10, 'ä»£ç³–':10, 'ç ´æŸè£…ç½®':2, 'è£…ç½®':1, 'ç³–':3, 'é…®å‡é›†':3, 'æµ†æœç§å­':0, 'èŠ½é’ˆç§å­':0
    };

    // ---------- æ¸¸æˆçŠ¶æ€ ----------
    let gameState = {
        playerLevel: 1,
        playerExp: 0,
        resources: { ...INIT_RESOURCES, 'åˆæˆçŸ³':0, 'ä½çº§expèµ„æ–™':0, 'ä¸­çº§expèµ„æ–™':0, 'é«˜çº§expèµ„æ–™':0 },
        buildings: [],
        nextId: 100,
        powerSupply: 1000, // åŠ¨æ€è®¡ç®—
    };

    // åˆå§‹åŒ–å»ºç­‘ (å¼€å±€)
    function initBuildings() {
        gameState.buildings = [
            { id:1, type:'åŠ å·¥ç«™', level:1, enabled:true, currentRecipe:0, progress:0, recipeIndex:0 },
            { id:2, type:'åˆ¶é€ ç«™', level:1, enabled:true, currentRecipe:0, progress:0, recipeIndex:0 },
            { id:3, type:'å‘ç”µç«™', level:1, enabled:true, currentRecipe:null, progress:0, recipeIndex:-1 }, // å‘ç”µç«™æ— é…æ–¹
            { id:4, type:'å‘ç”µç«™', level:1, enabled:true, currentRecipe:null, progress:0, recipeIndex:-1 },
            { id:5, type:'é‡‡çŸ¿æœº', level:1, enabled:true, currentRecipe:0, progress:0, recipeIndex:0 },
            { id:6, type:'è´¸æ˜“ç«™', level:1, enabled:true, currentRecipe:0, progress:0, recipeIndex:0 },
        ];
        gameState.nextId = 100;
    }
    if (!localStorage.getItem(STORAGE_KEY)) {
        initBuildings();
        // ç§æ¤ç«™å¥–åŠ± (å¼€å±€æ— , å»ºé€ åç»™)
    } else {
        try { gameState = JSON.parse(localStorage.getItem(STORAGE_KEY)); } catch { initBuildings(); }
    }

    // è¾…åŠ©: è®¡ç®—æ€»ä¾›ç”µ/è€—ç”µ
    function recalcPower() {
        let supply = 0;
        for (let b of gameState.buildings) {
            if (b.type === 'å‘ç”µç«™') {
                if (b.level === 1) supply += 500;
                else if (b.level === 2) supply += 700;
                else if (b.level === 3) supply += 1000;
            }
        }
        let usage = 0;
        for (let b of gameState.buildings) {
            if (b.type === 'å‘ç”µç«™') continue;
            if (b.enabled) usage += POWER_COST[b.type] || 150;
        }
        gameState.powerSupply = supply;
        return { supply, usage };
    }

    // æ£€æŸ¥ç”µé‡æ˜¯å¦è¶³å¤Ÿæ‰€æœ‰å¼€å¯å»ºç­‘å·¥ä½œ
    function powerOk() {
        let { supply, usage } = recalcPower();
        return usage <= supply;
    }

    // è·å–å»ºç­‘å¯ç”¨é…æ–¹
    function getRecipesForBuilding(b) {
        if (b.type === 'å‘ç”µç«™') return [];
        return RECIPES.filter(r => r.bid === b.type && r.level <= b.level);
    }

    // å°è¯•ç”Ÿäº§ tick (æ¯ç§’è°ƒç”¨)
    function productionTick() {
        if (!powerOk()) return; // ç”µé‡ä¸è¶³ï¼Œæ‰€æœ‰æš‚åœ

        for (let b of gameState.buildings) {
            if (b.type === 'å‘ç”µç«™' || !b.enabled) continue;
            let recipes = getRecipesForBuilding(b);
            if (recipes.length === 0) continue;
            let recipe = recipes[b.recipeIndex] || recipes[0];
            if (!recipe) continue;
            // æ£€æŸ¥åŸæ–™
            let canCraft = true;
            for (let [mat, need] of Object.entries(recipe.input)) {
                if ((gameState.resources[mat] || 0) < need) { canCraft = false; break; }
            }
            if (!canCraft) continue; // åŸæ–™ä¸è¶³

            // å¢åŠ è¿›åº¦
            b.progress = (b.progress || 0) + 1;
            if (b.progress >= recipe.time) {
                // æ‰£é™¤åŸæ–™ï¼Œæ·»åŠ äº§ç‰©
                for (let [mat, need] of Object.entries(recipe.input)) {
                    gameState.resources[mat] = (gameState.resources[mat] || 0) - need;
                }
                for (let [prod, qty] of Object.entries(recipe.output)) {
                    gameState.resources[prod] = (gameState.resources[prod] || 0) + qty;
                }
                b.progress = 0;
            }
        }
        saveGame();
        renderAll();
    }

    // å‡çº§å»ºç­‘
    function upgradeBuilding(b) {
        let nextLevel = b.level + 1;
        let req = UPGRADE_REQ[b.type]?.[nextLevel];
        if (!req) return false;
        if (gameState.playerLevel < req.level) { alert('ç©å®¶ç­‰çº§ä¸è¶³'); return false; }
        for (let [mat, qty] of Object.entries(req.mat)) {
            if ((gameState.resources[mat] || 0) < qty) { alert('ææ–™ä¸è¶³'); return false; }
        }
        for (let [mat, qty] of Object.entries(req.mat)) gameState.resources[mat] -= qty;
        b.level = nextLevel;
        if (b.type === 'ç§æ¤ç«™' && nextLevel === 2) {
            gameState.resources['èŠ½é’ˆç§å­'] = (gameState.resources['èŠ½é’ˆç§å­'] || 0) + 3; // å¥–åŠ±
        }
        saveGame(); renderAll(); return true;
    }

    // å»ºé€ æ–°å»ºç­‘
    function buildNew(type) {
        let req = BUILD_REQ[type];
        if (!req) return;
        if (gameState.playerLevel < req.level) { alert('ç­‰çº§ä¸è¶³'); return; }
        for (let [mat, qty] of Object.entries(req.mat)) {
            if ((gameState.resources[mat] || 0) < qty) { alert('ææ–™ä¸è¶³'); return; }
        }
        for (let [mat, qty] of Object.entries(req.mat)) gameState.resources[mat] -= qty;
        let newB = {
            id: gameState.nextId++,
            type: type,
            level: 1,
            enabled: true,
            currentRecipe: 0,
            progress: 0,
            recipeIndex: 0,
        };
        if (type === 'ç§æ¤ç«™') {
            gameState.resources['æµ†æœç§å­'] = (gameState.resources['æµ†æœç§å­'] || 0) + 3; // ä¸€çº§å¥–åŠ±
        }
        gameState.buildings.push(newB);
        saveGame(); renderAll();
    }

    // ä½¿ç”¨expèµ„æ–™
    function useExpItem(item) {
        let gain = 0;
        if (item === 'ä½çº§expèµ„æ–™') gain = 10;
        else if (item === 'ä¸­çº§expèµ„æ–™') gain = 50;
        else if (item === 'é«˜çº§expèµ„æ–™') gain = 200;
        else return;
        if (gameState.resources[item] > 0) {
            gameState.resources[item]--;
            gameState.playerExp = (gameState.playerExp || 0) + gain;
            // ç®€å•å‡çº§ï¼šæ¯100expä¸€çº§
            let newLevel = Math.floor(gameState.playerExp / 100) + 1;
            if (newLevel > gameState.playerLevel) gameState.playerLevel = newLevel;
            saveGame(); renderAll();
        }
    }

    // ä¿å­˜
    function saveGame() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(gameState));
    }

    // ---------- æ¸²æŸ“ ----------
    function renderResources() {
        document.getElementById('expDisplay').innerText = gameState.playerExp;
        document.getElementById('synthStoneDisplay').innerText = gameState.resources['åˆæˆçŸ³'] || 0;
        document.getElementById('playerLevel').innerText = gameState.playerLevel;
        let { supply, usage } = recalcPower();
        document.getElementById('powerSupply').innerText = supply;
        document.getElementById('powerUsage').innerText = usage;
        document.getElementById('powerDisplay').innerText = `${usage}/${supply}`;
    }

    function renderStorage() {
        let grid = document.getElementById('storageGrid');
        let html = '';
        for (let [name, color] of Object.entries(ITEMS)) {
            let qty = gameState.resources[name] || 0;
            let useBtn = (name.includes('expèµ„æ–™')) ? `<button class="item-use" data-item="${name}">ä½¿ç”¨</button>` : '';
            html += `<div class="item-card item-${color}"><div class="item-name">${name}</div><div class="item-qty">${qty}</div>${useBtn}</div>`;
        }
        grid.innerHTML = html;
        // ç»‘å®šä½¿ç”¨äº‹ä»¶
        document.querySelectorAll('.item-use').forEach(btn => {
            btn.addEventListener('click', (e) => {
                let item = e.target.dataset.item;
                useExpItem(item);
            });
        });
    }

    function renderProduction() {
        let container = document.getElementById('buildingsContainer');
        let html = '';
        for (let b of gameState.buildings) {
            let recipes = getRecipesForBuilding(b);
            let recipeOptions = recipes.map((r, idx) => `<option value="${idx}" ${b.recipeIndex===idx?'selected':''}>${r.name} (${r.time}s)</option>`).join('');
            let progressWidth = (b.progress || 0) / (recipes[b.recipeIndex]?.time || 1) * 100;
            let switchClass = b.enabled ? 'switch on' : 'switch';
            let powerCost = POWER_COST[b.type] || 0;
            html += `<div class="building-card" data-id="${b.id}">
                <div class="building-info">
                    <div class="building-name">${b.type}</div>
                    <div class="building-level">Lv.${b.level}</div>
                    <div class="power-cost">âš¡${powerCost}</div>
                </div>
                <div class="building-switch">
                    <div class="${switchClass}" data-id="${b.id}" data-action="toggle"></div>
                    <span style="color:white">${b.enabled?'è¿è¡Œä¸­':'å…³é—­'}</span>
                </div>
                ${b.type !== 'å‘ç”µç«™' ? `
                <select class="recipe-select" data-id="${b.id}" data-action="recipe">${recipeOptions}</select>
                <div class="progress-bar"><div class="progress-fill" style="width:${progressWidth}%"></div></div>
                ` : '<div style="width:200px"></div>'}
                <button class="btn" data-id="${b.id}" data-action="upgrade">å‡çº§</button>
            </div>`;
        }
        container.innerHTML = html;
        // äº‹ä»¶ç»‘å®š
        document.querySelectorAll('[data-action="toggle"]').forEach(el => {
            el.addEventListener('click', (e) => {
                let id = e.target.dataset.id;
                let b = gameState.buildings.find(b => b.id == id);
                if (b) { b.enabled = !b.enabled; saveGame(); renderAll(); }
            });
        });
        document.querySelectorAll('[data-action="recipe"]').forEach(sel => {
            sel.addEventListener('change', (e) => {
                let id = e.target.dataset.id;
                let b = gameState.buildings.find(b => b.id == id);
                if (b) { b.recipeIndex = parseInt(e.target.value); b.progress = 0; saveGame(); renderAll(); }
            });
        });
        document.querySelectorAll('[data-action="upgrade"]').forEach(btn => {
            btn.addEventListener('click', (e) => {
                let id = e.target.dataset.id;
                let b = gameState.buildings.find(b => b.id == id);
                if (b) upgradeBuilding(b);
            });
        });
    }

    function renderAll() {
        renderResources();
        if (document.getElementById('productionPage').style.display !== 'none') renderProduction();
        if (document.getElementById('storagePage').style.display !== 'none') renderStorage();
    }

    // åˆ†é¡µ
    document.getElementById('tabProduction').addEventListener('click', ()=>{
        document.getElementById('tabProduction').classList.add('active');
        document.getElementById('tabStorage').classList.remove('active');
        document.getElementById('productionPage').style.display = 'block';
        document.getElementById('storagePage').style.display = 'none';
        renderProduction();
    });
    document.getElementById('tabStorage').addEventListener('click', ()=>{
        document.getElementById('tabStorage').classList.add('active');
        document.getElementById('tabProduction').classList.remove('active');
        document.getElementById('storagePage').style.display = 'block';
        document.getElementById('productionPage').style.display = 'none';
        renderStorage();
    });

    // å»ºé€ èœå•
    document.getElementById('openBuildMenu').addEventListener('click', ()=>{
        document.getElementById('buildSelector').style.display = 'block';
    });
    document.getElementById('cancelBuild').addEventListener('click', ()=>{
        document.getElementById('buildSelector').style.display = 'none';
    });
    document.getElementById('confirmBuild').addEventListener('click', ()=>{
        let type = document.getElementById('buildingTypeSelect').value;
        buildNew(type);
        document.getElementById('buildSelector').style.display = 'none';
    });

    // æ¯ç§’å¾ªç¯
    setInterval(() => { productionTick(); }, 1000);
    // åˆå§‹æ¸²æŸ“
    renderAll();
    saveGame();
})();
</script>
</body>
</html>
